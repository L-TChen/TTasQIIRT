open import Prelude

module Theory.SC+Pi+B.QIIRT-tyOf.IxModel.Canonicity where

open import Cubical.Data.Sum

-- open import Theory.SC+Pi+B.QIIRT-tyOf.Syntax
-- open Var

open import Theory.SC+Pi+B.QIIRT-tyOf.Model
open import Theory.SC+Pi+B.QIIRT-tyOf.Model.Term
open import Theory.SC.QIIRT-tyOf.DisplayedModel
open import Theory.SC+Pi+B.QIIRT-tyOf.DisplayedModel

open import Theory.SC+Pi+B.QIIRT-tyOf.DisplayedModel Term

open SC+Pi+B Term
open Var

-- TODO: Target hSet rather than relying on global UIP
postulate
  UIP : {A : Set â„“} â†’ {x y : A} â†’ isProp (x â‰¡ y)

UIP' : {A : Set â„“} â†’ isSet A
UIP' x y = UIP


Ctxá´³ : Ctx â†’ Setâ‚
Ctxá´³ Î“ = Sub âˆ… Î“ â†’ Set

Subá´³ : Ctxá´³ Î“ â†’ Ctxá´³ Î” â†’ Sub Î“ Î” â†’ Set
Subá´³ {Î“} {Î”} Î“âˆ™ Î”âˆ™ Ïƒ =
  (Î³ : Sub âˆ… Î“) â†’ Î“âˆ™ Î³ â†’ Î”âˆ™ (Ïƒ âˆ˜ Î³)

Subá´³-is-set : (Î“âˆ™ : Ctxá´³ Î“) â†’ (Î”âˆ™ : Ctxá´³ Î”) â†’ (Ïƒ : Sub Î“ Î”)
             â†’ isSet (Subá´³ Î“âˆ™ Î”âˆ™ Ïƒ)
Subá´³-is-set Î“âˆ™ Î”âˆ™ Ïƒ = isSetÎ 2 (Î» Î³ r â†’ UIP')

-- TODO: Target a universe of sets which is a set, instead of relying on global UIP

Tyá´³ : Ctxá´³ Î“ â†’ Ty Î“ â†’ Setâ‚
Tyá´³ {Î“} Î“âˆ™ A = (Î³ : Sub âˆ… Î“) (Î³âˆ™ : Î“âˆ™ Î³) (t : Tm âˆ…) â†’ tyOf t â‰¡ A [ Î³ ]T â†’ Set

Tyá´³-is-set : (Î“âˆ™ : Ctxá´³ Î“) â†’ (A : Ty Î“)
           â†’ isSet (Tyá´³ Î“âˆ™ A)
Tyá´³-is-set Î“âˆ™ t = isSetÎ 3 (Î» Î³ Î³âˆ™ t â†’ isSetÎ  Î» e â†’ UIP')

Tmá´³ : Ctxá´³ Î“ â†’ Tm Î“ â†’ Setâ‚
Tmá´³ {Î“} Î“âˆ™ t = (Î³ : Sub âˆ… Î“)(Î³âˆ™ : Î“âˆ™ Î³) â†’
  Î£[ Aâˆ™ âˆˆ Tyá´³ Î“âˆ™ (tyOf t) ] Aâˆ™ Î³ Î³âˆ™ (t [ Î³ ]t) refl

Tmá´³-is-set : (Î“âˆ™ : Ctxá´³ Î“) â†’ (t : Tm Î“)
           â†’ isSet (Tmá´³ Î“âˆ™ t)
Tmá´³-is-set Î“âˆ™ t = isSetÎ 2 (Î» Î³ Î³âˆ™ â†’ isSetÎ£ (Tyá´³-is-set Î“âˆ™ (tyOf t)) Î» Aâˆ™ â†’ UIP')


tyOfá´³ : {Î“á´³ : Ctxá´³ Î“} â†’ Tmá´³ Î“á´³ t â†’ Tyá´³ Î“á´³ (tyOf t)
tyOfá´³ {Î“} {t} {Î“á´³} tâˆ™ Î³ Î³âˆ™ t' p = tâˆ™ Î³ Î³âˆ™ .fst Î³ Î³âˆ™ t' p

ğ”¹á´³ : {Î“á´³ : Ctxá´³ Î“} â†’ Tyá´³ Î“á´³ ğ”¹
ğ”¹á´³ Î³ Î³á´³ t _ = (t â‰¡ tt) âŠ (t â‰¡ ff)

ttâˆ™ : {Î“á´³ : Ctxá´³ Î“} â†’ Tmá´³ Î“á´³ tt
ttâˆ™ Î³ Î³âˆ™ = ğ”¹á´³ , inl (tt[] Î³)

ffâˆ™ : {Î“á´³ : Ctxá´³ Î“} â†’ Tmá´³ Î“á´³ ff
ffâˆ™ Î³ Î³âˆ™ = ğ”¹á´³ , inr (ff[] Î³)

CanonMotâˆ™ : Motiveâˆ™ TermSC _ _ _ _
CanonMotâˆ™ = record
    { Ctxâˆ™  = Ctxá´³
    ; Tyâˆ™   = Tyá´³
    ; Subâˆ™  = Subá´³
    ; Tmâˆ™   = Tmá´³
    ; tyOfâˆ™ = tyOfá´³
    ; Subâˆ™-is-set = Subá´³-is-set
    ; Tyâˆ™-is-set = Tyá´³-is-set
    ; Tmâˆ™-is-set = Tmá´³-is-set
    }

CanonisSC : IsSCâˆ™ TermSC CanonMotâˆ™
CanonisSC = record
  { âˆ…âˆ™     = Î» _ â†’ Unit
  ; _,âˆ™_   = Î» Î“âˆ™ Aâˆ™ Î³a â†’
      Î£[ Î³âˆ™ âˆˆ Î“âˆ™ (Ï€â‚ {A = _} idS âˆ˜ Î³a) ] Aâˆ™ (Ï€â‚ idS âˆ˜ Î³a) Î³âˆ™ (Ï€â‚‚ idS [ Î³a ]t) ([âˆ˜]T _ _ _)
  ; _âˆ˜âˆ™_   = Î» {Î”} {Î”âˆ™} {Î˜} {Î˜âˆ™} {Ï„} {Î“} {Î“âˆ™} {Ïƒ} Ïƒâˆ™ Ï„âˆ™ Î³ Î³âˆ™ â†’
      subst Î˜âˆ™ (sym $ assocS _ _ _) (Ïƒâˆ™ (Ïƒ âˆ˜ Î³) (Ï„âˆ™ Î³ Î³âˆ™))
  ; idSâˆ™   = Î» {Î“âˆ™ = Î“âˆ™} Ïƒ Ïƒâˆ™ â†’ subst Î“âˆ™ (sym $ idSâˆ˜ Ïƒ) Ïƒâˆ™
  ; _âˆ˜idSâˆ™ = Î» Ïƒâˆ™ â†’ {!!}
  ; idSâˆ˜âˆ™_ = Î» Ïƒâˆ™ â†’ {!!}
  }
-- --   ; _[_]Tâˆ™ = {!!}
-- --   ; _[_]tâˆ™ = {!!}
-- --   ; tyOf[]âˆ™ = {!!}
-- --   ; âˆ…Sâˆ™ = {!!}
-- --   ; _,_âˆ¶[_,_]âˆ™ = {!!}
-- --   ; idSâˆ™ = {!!}
-- --   ; _âˆ˜âˆ™_ = {!!}
-- --   ; Ï€â‚âˆ™ = {!!}
-- --   ; Ï€â‚‚âˆ™ = {!!}
-- --   ; tyOfÏ€â‚‚âˆ™ = {!!}
-- --   ; idSâˆ˜âˆ™_ = {!!}
-- --   ; _âˆ˜idSâˆ™ = {!!}
-- --   ; assocSâˆ™ = {!!}
-- --   ; ,âˆ˜âˆ™ = {!!}
-- --   ; Î·Ï€âˆ™ = {!!}
-- --   ; Î·âˆ…âˆ™ = {!!}
-- --   ; Î²Ï€â‚âˆ™ = {!!}
-- --   ; Î²Ï€â‚‚âˆ™ = {!!}
-- --   ; [idS]Tâˆ™ = {!!}
-- --   ; [âˆ˜]Tâˆ™ = {!!}
-- --   ; [idS]tâˆ™ = {!!}
-- --   ; [âˆ˜]tâˆ™ = {!!}
-- --   ; Uâˆ™ = {!!}
-- --   ; U[]âˆ™ = {!!}
-- --   }

-- -- -- âˆ…á´³ : Ctxá´³ âˆ…
-- -- -- âˆ…á´³ _ = Unit

-- -- -- _,á´³_ : (Î“á´³ : Ctxá´³ Î“) â†’ Tyá´³ Î“á´³ A â†’ Ctxá´³ (Î“ , A)
-- -- -- Î“á´³ ,á´³ Aá´³ = Î» Î³ â†’ Î£[ Î³á´³ âˆˆ Î“á´³ (Ï€â‚ Î³) ] Aá´³ (Ï€â‚ Î³) Î³á´³ (Ï€â‚‚ Î³)

-- -- -- _[_]Tá´³
-- -- --   : {Î“á´³ : Ctxá´³ Î“}{Î”á´³ : Ctxá´³ Î”}
-- -- --   â†’ Tyá´³ Î”á´³ A â†’ Subá´³ Î“á´³ Î”á´³ Ïƒ â†’ Tyá´³ Î“á´³ (A [ Ïƒ ])
-- -- -- _[_]Tá´³ {Ïƒ = Ïƒ} Aá´³ Ïƒá´³ = Î» Î³ Î³á´³ â†’ Aá´³ (Ïƒ âˆ˜ Î³) (Ïƒá´³ Î³ Î³á´³)

-- -- -- _[_]tá´³
-- -- --   : {Î“á´³ : Ctxá´³ Î“}{Î”á´³ : Ctxá´³ Î”}
-- -- --   â†’ Tmá´³ Î”á´³ t â†’ Subá´³ Î“á´³ Î”á´³ Ïƒ â†’ Tmá´³ Î“á´³ (t [ Ïƒ ])
-- -- -- _[_]tá´³ {t = t} {Ïƒ} tá´³ Ïƒá´³ = Î» Î³ Î³á´³
-- -- --   â†’ tyOf t [ Ïƒ ] , _[_]Tá´³ {A = tyOf t} (tyOfá´³ tá´³) Ïƒá´³ , refl ,
-- -- --     let (A , Aá´³ , p , aá´³) = tá´³ (Ïƒ âˆ˜ Î³) (Ïƒá´³ Î³ Î³á´³)
-- -- --     in sym ([âˆ˜]t _ _ _) , transport (Î» i â†’ Aá´³ (Ïƒ âˆ˜ Î³) (Ïƒá´³ Î³ Î³á´³) ([âˆ˜]t t Î³ Ïƒ (~ i))) aá´³

-- -- -- âˆ…Sá´³ : {Î“á´³ : Ctxá´³ Î“} â†’ Subá´³ Î“á´³ âˆ…á´³ âˆ…
-- -- -- âˆ…Sá´³ _ _ = â‹†

-- -- -- _âˆ˜á´³_
-- -- --   : {Î“á´³ : Ctxá´³ Î“}{Î”á´³ : Ctxá´³ Î”}{Î˜á´³ : Ctxá´³ Î˜}
-- -- --   â†’ Subá´³ Î”á´³ Î˜á´³ Ïƒ â†’ Subá´³ Î“á´³ Î”á´³ Ï„
-- -- --   â†’ Subá´³ Î“á´³ Î˜á´³ (Ïƒ âˆ˜ Ï„)
-- -- -- _âˆ˜á´³_ {Ïƒ = Ïƒ} {Ï„} {Î˜á´³ = Î˜á´³} Ïƒá´³ Ï„á´³ Î³ Î³á´³ = transport (Î» i â†’ Î˜á´³ (assocS Î³ Ï„ Ïƒ (~ i))) (Ïƒá´³ (Ï„ âˆ˜ Î³) (Ï„á´³ Î³ Î³á´³))

-- -- -- idSá´³ : {Î“á´³ : Ctxá´³ Î“} â†’ Subá´³ Î“á´³ Î“á´³ idS
-- -- -- idSá´³ {Î“á´³ = Î“á´³} Î³ Î³á´³ = transport (Î» i â†’ Î“á´³ ((idSâˆ˜ Î³) (~ i))) Î³á´³

-- -- -- Ï€â‚á´³
-- -- --   : {Î“á´³ : Ctxá´³ Î“}{Î”á´³ : Ctxá´³ Î”}{Aá´³ : Tyá´³ Î”á´³ A}
-- -- --   â†’ Subá´³ Î“á´³ (Î”á´³ ,á´³ Aá´³) Ïƒ
-- -- --   â†’ Subá´³ Î“á´³ Î”á´³ (Ï€â‚ Ïƒ)
-- -- -- Ï€â‚á´³ {Ïƒ = Ïƒ} {Î”á´³ = Î”á´³} Ïƒá´³ Î³ Î³á´³ = let (Î´á´³ , _) = Ïƒá´³ Î³ Î³á´³ in transport (Î» i â†’ Î”á´³ (Ï€â‚âˆ˜ Ïƒ Î³ i)) Î´á´³

-- -- -- Ï€â‚‚á´³
-- -- --   : {Ïƒ : Sub Î“ (Î” , A)}{Î“á´³ : Ctxá´³ Î“}{Î”á´³ : Ctxá´³ Î”}{Aá´³ : Tyá´³ Î”á´³ A}
-- -- --   â†’ Subá´³ Î“á´³ (Î”á´³ ,á´³ Aá´³) Ïƒ
-- -- --   â†’ Tmá´³ Î“á´³ (Ï€â‚‚ Ïƒ)
-- -- -- Ï€â‚‚á´³ {A = A} {Ïƒ = Ïƒ} {Î”á´³ = Î”á´³} {Aá´³} Ïƒá´³ Î³ Î³á´³ =
-- -- --   A [ Ï€â‚ Ïƒ ] , _[_]Tá´³ {A = A} Aá´³ (Ï€â‚á´³ {A = A} {Aá´³ = Aá´³} Ïƒá´³) , refl ,
-- -- --   let (Î´á´³ , aá´³) = Ïƒá´³ Î³ Î³á´³
-- -- --   in transport (Î» i â†’ Aá´³ (Ï€â‚âˆ˜ Ïƒ Î³ i) {!   !} (Ï€â‚‚âˆ˜ Ïƒ Î³ i)) aá´³

-- -- -- _,á´³_âˆ¶[_âˆ£_]
-- -- --   : {Î“á´³ : Ctxá´³ Î“}{Î”á´³ : Ctxá´³ Î”}{Aá´³ : Tyá´³ Î”á´³ A}
-- -- --   â†’ (Ïƒá´³ : Subá´³ Î“á´³ Î”á´³ Ïƒ)(tá´³ : Tmá´³ Î“á´³ t)(p : tyOf t â‰¡ A [ Ïƒ ]) â†’ tyOfá´³ tá´³ â‰¡ _[_]Tá´³ {A = A} Aá´³ Ïƒá´³
-- -- --   â†’ Subá´³ Î“á´³ (Î”á´³ ,á´³ Aá´³) (Ïƒ , t âˆ¶[ p ])
-- -- -- _,á´³_âˆ¶[_âˆ£_] {Î“} {Î”} {A} {Ïƒ} {t} {Î“á´³} {Î”á´³} {Aá´³} Ïƒá´³ tá´³ p pá´³ Î³ Î³á´³ =
-- -- --   transport (cong Î”á´³ (sym (cong Ï€â‚ (âŸ¨,âˆ˜âŸ© Ïƒ t Î³ p) âˆ™ Î²Ï€â‚ (Ïƒ âˆ˜ Î³) _ _))) (Ïƒá´³ Î³ Î³á´³) ,
-- -- --   {!   !}

-- -- -- _â†‘á´³_
-- -- --   : {Î“á´³ : Ctxá´³ Î“}{Î”á´³ : Ctxá´³ Î”}(Ïƒá´³ : Subá´³ Î“á´³ Î”á´³ Ïƒ)(Aá´³ : Tyá´³ Î”á´³ A)
-- -- --   â†’ Subá´³ (Î“á´³ ,á´³ _[_]Tá´³ {A = A} Aá´³ Ïƒá´³) (Î”á´³ ,á´³ Aá´³) (Ïƒ â†‘ A)
-- -- -- _â†‘á´³_ {Î“} {Î”} {Ïƒ} {A} {Î“á´³} {Î”á´³} Ïƒá´³ Aá´³ =
-- -- --   _,á´³_âˆ¶[_âˆ£_] {Î“ , A [ Ïƒ ]} {Î”} {A} {Ïƒ âˆ˜ Ï€â‚ idS} {Ï€â‚‚ idS} {Î“á´³ ,á´³ _[_]Tá´³ {A = A} Aá´³ Ïƒá´³} {Î”á´³} {Aá´³}
-- -- --     (_âˆ˜á´³_ {Î˜á´³ = Î”á´³} Ïƒá´³ (Ï€â‚á´³ {A = A [ Ïƒ ]} {Aá´³ = _[_]Tá´³ {A = A} Aá´³ Ïƒá´³} idSá´³))
-- -- --     (Ï€â‚‚á´³ {Aá´³ = _[_]Tá´³ {A = A} Aá´³ Ïƒá´³} idSá´³)
-- -- --     ([âˆ˜]T A (Ï€â‚ idS) Ïƒ)
-- -- --     {!   !}

-- -- -- Î á´³
-- -- --   : {Î“á´³ : Ctxá´³ Î“}
-- -- --   â†’ (Aá´³ : Tyá´³ Î“á´³ A)(Bá´³ : Tyá´³ (Î“á´³ ,á´³ Aá´³) B)
-- -- --   â†’ Tyá´³ Î“á´³ (Î  A B)
-- -- -- Î á´³ {Î“} {A} {B} {Î“á´³} Aá´³ Bá´³ Î³ Î³á´³ t =
-- -- --   Î£[ p âˆˆ tyOf t â‰¡ Î  (A [ Î³ ]) (B [ Î³ â†‘ A ]) ]
-- -- --   ((a : Tm âˆ…)(q : tyOf a â‰¡ A [ Î³ ])(aá´³ : Aá´³ Î³ Î³á´³ a)
-- -- --   â†’ Bá´³ (_âˆ˜_ {âˆ… , A [ Î³ ]} {Î“ , A} {âˆ…} (Î³ â†‘ A) (idS , a âˆ¶[ q âˆ™ [idS]T ]))
-- -- --        (_âˆ˜á´³_ {âˆ…} {âˆ… , A [ Î³ ]} {Î“ , A} {Î³ â†‘ A} {idS , a âˆ¶[ q âˆ™ [idS]T ]} {âˆ…á´³}
-- -- --              (_â†‘á´³_ {Ïƒ = Î³} (Î» Î³' _ â†’ transport (Î» i â†’ Î“á´³ ((sym (Î³ âˆ˜idS) âˆ™ (Î» j â†’ Î³ âˆ˜ (Î·âˆ… idS âˆ™ sym (Î·âˆ… Î³')) j)) i)) Î³á´³) Aá´³)
-- -- --              {!   !} idS â‹†)
-- -- --        (app t p [ idS , a âˆ¶[ q âˆ™ [idS]T ] ])
-- -- --   )

-- -- -- appá´³
-- -- --   : {Î“á´³ : Ctxá´³ Î“}{Aá´³ : Tyá´³ Î“á´³ A}{Bá´³ : Tyá´³ (Î“á´³ ,á´³ Aá´³) B}
-- -- --   â†’ (tá´³ : Tmá´³ Î“á´³ t)(p : tyOf t â‰¡ Î  A B) â†’ tyOfá´³ tá´³ â‰¡[ i âŠ¢ Tyá´³ Î“á´³ (p i) ] Î á´³ {A = A} {B = B} Aá´³ Bá´³
-- -- --   â†’ Tmá´³ (Î“á´³ ,á´³ Aá´³) (app t p)
-- -- -- appá´³ {A = A} {B} {Bá´³ = Bá´³} tá´³ p pá´³ Î³ (Ï€â‚Î³á´³ , _) = B , Bá´³ , refl ,
-- -- --   let (A' , A'á´³ , q , aá´³) = tá´³ (Ï€â‚ Î³) Ï€â‚Î³á´³
-- -- --   in {!   !}

-- -- -- absá´³
-- -- --   : {Î“á´³ : Ctxá´³ Î“}{Aá´³ : Tyá´³ Î“á´³ A}(tá´³ : Tmá´³ {Î“ , A} (Î“á´³ ,á´³ Aá´³) t)
-- -- --   â†’ Tmá´³ Î“á´³ (abs t)
-- -- -- absá´³ {A = A} {t = t} {Aá´³ = Aá´³} tá´³ Î³ Î³á´³ = Î  A (tyOf t) , Î á´³ {A = A} {B = tyOf t} Aá´³ (tyOfá´³ tá´³) , (Î» _ â†’ Î  A (tyOf t)) ,
-- -- --   Î [] {A = A} {B = tyOf t} {Ïƒ = Î³} , Î» a q aá´³ â†’ {!   !}
